const items = [
  {
    id: 8233700290563465,
    name: 'Modern Concrete Pants',
    price: '584.00',
    description:
      "Boston's most advanced compression wear technology increases muscle oxygenation, stabilizes active muscles",
    categories: ['alpha', 'gamma', 'delta', 'epsilon']
  },
  {
    id: 5835466026184087,
    name: 'Handmade Rubber Shirt',
    price: '164.00',
    description: 'The Football Is Good For Training And Recreational Purposes',
    categories: ['beta', 'gamma', 'zeta']
  },
  {
    id: 6390185462858215,
    name: 'Modern Steel Fish',
    price: '178.00',
    description:
      'The Apollotech B340 is an affordable wireless mouse with reliable connectivity, 12 months battery life and modern design',
    categories: ['beta', 'delta', 'zeta']
  },
  {
    id: 5855536910836153,
    name: 'Fantastic Frozen Chair',
    price: '755.00',
    description:
      'The Apollotech B340 is an affordable wireless mouse with reliable connectivity, 12 months battery life and modern design',
    categories: ['beta', 'gamma', 'delta', 'epsilon']
  },
  {
    id: 1654744854393292,
    name: 'Electronic Wooden Towels',
    price: '308.00',
    description:
      'New ABC 13 9370, 13.3, 5th Gen CoreA5-8250U, 8GB RAM, 256GB SSD, power UHD Graphics, OS 10 Home, OS Office A & J 2016',
    categories: ['beta', 'gamma', 'zeta']
  },
  {
    id: 3762175409755162,
    name: 'Bespoke Frozen Pants',
    price: '514.00',
    description: 'The Football Is Good For Training And Recreational Purposes',
    categories: ['beta', 'gamma', 'zeta']
  },
  {
    id: 6664378315230119,
    name: 'Tasty Steel Hat',
    price: '796.00',
    description:
      'New range of formal shirts are designed keeping you in mind. With fits and styling that will make you stand apart',
    categories: ['epsilon', 'zeta']
  },
  {
    id: 4596063114174427,
    name: 'Bespoke Fresh Mouse',
    price: '101.00',
    description: 'Carbonite web goalkeeper gloves are ergonomically designed to give easy fit',
    categories: ['gamma', 'epsilon', 'zeta']
  },
  {
    id: 3125847565777812,
    name: 'Incredible Granite Car',
    price: '605.00',
    description: 'The Football Is Good For Training And Recreational Purposes',
    categories: ['gamma', 'zeta']
  },
  {
    id: 3097129381555346,
    name: 'Ergonomic Frozen Ball',
    price: '12.00',
    description:
      'The automobile layout consists of a front-engine design, with transaxle-type transmissions mounted at the rear of the engine and four wheel drive',
    categories: ['alpha', 'beta']
  },
  {
    id: 515017105246442,
    name: 'Unbranded Fresh Salad',
    price: '663.00',
    description:
      'New ABC 13 9370, 13.3, 5th Gen CoreA5-8250U, 8GB RAM, 256GB SSD, power UHD Graphics, OS 10 Home, OS Office A & J 2016',
    categories: ['delta', 'epsilon']
  },
  {
    id: 2705883193710878,
    name: 'Fantastic Granite Gloves',
    price: '554.00',
    description:
      'Andy shoes are designed to keeping in mind durability as well as trends, the most stylish range of shoes & sandals',
    categories: ['beta', 'gamma', 'epsilon', 'zeta']
  },
  {
    id: 2381373616328518,
    name: 'Generic Fresh Keyboard',
    price: '803.00',
    description:
      'New ABC 13 9370, 13.3, 5th Gen CoreA5-8250U, 8GB RAM, 256GB SSD, power UHD Graphics, OS 10 Home, OS Office A & J 2016',
    categories: ['gamma', 'zeta']
  },
  {
    id: 4233809608771674,
    name: 'Gorgeous Rubber Sausages',
    price: '398.00',
    description: 'Carbonite web goalkeeper gloves are ergonomically designed to give easy fit',
    categories: ['gamma', 'zeta']
  },
  {
    id: 395326174392282,
    name: 'Small Bronze Cheese',
    price: '135.00',
    description:
      'New ABC 13 9370, 13.3, 5th Gen CoreA5-8250U, 8GB RAM, 256GB SSD, power UHD Graphics, OS 10 Home, OS Office A & J 2016',
    categories: ['alpha', 'delta', 'epsilon', 'zeta']
  },
  {
    id: 7390058845316893,
    name: 'Rustic Fresh Pizza',
    price: '549.00',
    description:
      'The beautiful range of Apple Naturalé that has an exciting mix of natural ingredients. With the Goodness of 100% Natural Ingredients',
    categories: ['beta', 'delta']
  },
  {
    id: 1287213499817500,
    name: 'Recycled Fresh Bike',
    price: '437.00',
    description:
      'The automobile layout consists of a front-engine design, with transaxle-type transmissions mounted at the rear of the engine and four wheel drive',
    categories: ['beta', 'epsilon', 'zeta']
  },
  {
    id: 4667995348273989,
    name: 'Sleek Fresh Chips',
    price: '468.00',
    description:
      'Andy shoes are designed to keeping in mind durability as well as trends, the most stylish range of shoes & sandals',
    categories: ['gamma', 'delta']
  },
  {
    id: 8597235316569697,
    name: 'Handcrafted Plastic Fish',
    price: '959.00',
    description:
      'The slim & simple Maple Gaming Keyboard from Dev Byte comes with a sleek body and 7- Color RGB LED Back-lighting for smart functionality',
    categories: ['beta', 'delta', 'epsilon', 'zeta']
  },
  {
    id: 6232556705264993,
    name: 'Licensed Metal Fish',
    price: '160.00',
    description:
      'New ABC 13 9370, 13.3, 5th Gen CoreA5-8250U, 8GB RAM, 256GB SSD, power UHD Graphics, OS 10 Home, OS Office A & J 2016',
    categories: ['beta', 'epsilon']
  },
  {
    id: 7158914361804327,
    name: 'Handmade Rubber Mouse',
    price: '167.00',
    description:
      "Boston's most advanced compression wear technology increases muscle oxygenation, stabilizes active muscles",
    categories: ['gamma', 'delta', 'epsilon', 'zeta']
  },
  {
    id: 5193309004993683,
    name: 'Elegant Granite Shoes',
    price: '927.00',
    description:
      'New range of formal shirts are designed keeping you in mind. With fits and styling that will make you stand apart',
    categories: ['beta', 'zeta']
  },
  {
    id: 3639515825002808,
    name: 'Recycled Wooden Cheese',
    price: '619.00',
    description:
      'The slim & simple Maple Gaming Keyboard from Dev Byte comes with a sleek body and 7- Color RGB LED Back-lighting for smart functionality',
    categories: ['beta', 'delta', 'epsilon']
  },
  {
    id: 1516140501100062,
    name: 'Handcrafted Bronze Towels',
    price: '260.00',
    description:
      'Ergonomic executive chair upholstered in bonded black leather and PVC padded seat and back for all-day comfort and support',
    categories: ['alpha', 'gamma', 'epsilon', 'zeta']
  },
  {
    id: 2171968660384326,
    name: 'Oriental Bronze Car',
    price: '176.00',
    description:
      'The slim & simple Maple Gaming Keyboard from Dev Byte comes with a sleek body and 7- Color RGB LED Back-lighting for smart functionality',
    categories: ['alpha', 'delta', 'epsilon', 'zeta']
  },
  {
    id: 3743308261233982,
    name: 'Recycled Concrete Bacon',
    price: '883.00',
    description: 'Carbonite web goalkeeper gloves are ergonomically designed to give easy fit',
    categories: ['beta', 'gamma', 'epsilon', 'zeta']
  },
  {
    id: 7601461356998843,
    name: 'Unbranded Fresh Salad',
    price: '720.00',
    description:
      'The Apollotech B340 is an affordable wireless mouse with reliable connectivity, 12 months battery life and modern design',
    categories: ['alpha', 'beta', 'gamma', 'delta']
  },
  {
    id: 5928156636947635,
    name: 'Elegant Wooden Shirt',
    price: '262.00',
    description:
      'Andy shoes are designed to keeping in mind durability as well as trends, the most stylish range of shoes & sandals',
    categories: ['alpha', 'gamma', 'epsilon', 'zeta']
  },
  {
    id: 7909222611124101,
    name: 'Sleek Cotton Ball',
    price: '708.00',
    description:
      "Boston's most advanced compression wear technology increases muscle oxygenation, stabilizes active muscles",
    categories: ['beta', 'delta', 'epsilon']
  },
  {
    id: 8181998196585739,
    name: 'Fantastic Concrete Car',
    price: '319.00',
    description:
      'The Apollotech B340 is an affordable wireless mouse with reliable connectivity, 12 months battery life and modern design',
    categories: ['alpha', 'gamma', 'delta', 'epsilon']
  },
  {
    id: 6630295315698627,
    name: 'Incredible Fresh Mouse',
    price: '273.00',
    description:
      "Boston's most advanced compression wear technology increases muscle oxygenation, stabilizes active muscles",
    categories: ['beta', 'gamma', 'zeta']
  },
  {
    id: 2602264971963536,
    name: 'Incredible Bronze Sausages',
    price: '525.00',
    description:
      'New range of formal shirts are designed keeping you in mind. With fits and styling that will make you stand apart',
    categories: ['alpha', 'epsilon']
  }
];

const user = {
  username: 'taro',
  password: 'rakuten'
};

function handleEnterKeyPress(event) {
  if (event.keyCode === 13) event.currentTarget.exec();
}

// add event listeners
window.addEventListener('DOMContentLoaded', function () {
  try {
    const uname = document.getElementById('uname');
    if (uname) {
      uname.exec = login;
      uname.addEventListener('keyup', handleEnterKeyPress);
    }

    const pword = document.getElementById('pword');
    if (pword) {
      pword.addEventListener('keyup', handleEnterKeyPress);
      pword.exec = login;
    }

    const searchBar = document.getElementById('searchPrompt');
    if (searchBar) {
      searchBar.exec = goToSearch;
      searchBar.addEventListener('keyup', handleEnterKeyPress);
    }
  } catch (error) {
    console.error(error);
  }
});

// functions
function goToSearch() {
  const prompt = document.getElementById('searchPrompt').value || '';
  window.location.href = '/search_results.html?search=' + prompt;
}

/*
  for binding Add to Cart buttons generated in item cards for click event
  itemId: <String> item id corresponding to the item card where buttons are to be bound
*/
function bindButton(itemId) {
  const $newElementsToTrack = jQuery('#add-to-cart-div-' + itemId.toString()).find('[data-ratId]');
  RAT.bind($newElementsToTrack);
}

function getSearchRes() {
  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const prompt = urlparams.get('search');
  let page = urlparams.get('p');
  try {
    page = parseInt(page);
    if (page === null || isNaN(page)) page = 1;
  } catch (err) {
    page = 1;
  }

  let results = items;
  if (prompt != null && prompt != '') {
    results = items.filter((i) => i.name.toLowerCase().includes(prompt));
    document.getElementById('searchPrompt').value = prompt;
  }

  const displayCount = 9;
  const BreakError = {};
  const startInd = (page - 1) * displayCount;
  const endInd =
    startInd + displayCount <= results.length ? startInd + displayCount : results.length;

  createPgn(Math.ceil(results.length / displayCount), page);

  try {
    results.slice(startInd, endInd).forEach(function (item, index, arr) {
      const icard = generateItemCard(item);
      document.getElementById('item-display').appendChild(icard);
      bindButton(item.id);
    });
  } catch (err) {
    if (err !== BreakError) throw err;
  }

  displayCategories();
}

function createPgn(pageCount = 1, currentPage = 1) {
  const paginationList = document.getElementById('search-pages');

  for (let i = 1; i <= pageCount; i++) {
    const tmp = document.createElement('a');
    tmp.setAttribute('href', '#');
    tmp.setAttribute('onclick', 'moveSearchPage(' + i.toString() + ')');
    tmp.setAttribute(
      'class',
      'px-3 py-2 ml-0 leading-tight text-gray-500 bg-white rounded-none border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'
    );
    tmp.innerHTML = i.toString();
    const pg = document.createElement('li');
    pg.appendChild(tmp);
    if (i === currentPage) pg.firstElementChild.setAttribute('aria-current', 'page');
    paginationList.insertBefore(pg, paginationList.lastElementChild);
  }
}

function moveSearchPageNext() {
  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const prompt = urlparams.get('search');
  let page = urlparams.get('p');
  try {
    page = parseInt(page);
    if (page === null || isNaN(page)) page = 1;
  } catch (err) {
    page = 1;
  }
  const pageCount = document.getElementById('search-pages').childElementCount;
  if (page < pageCount - 2) {
    page += 1;
    window.location.href =
      window.location.origin +
      window.location.pathname +
      '?search=' +
      prompt +
      '&p=' +
      page.toString();
  }
}

function moveSearchPagePrevious() {
  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const prompt = urlparams.get('search');
  let page = urlparams.get('p');
  try {
    page = parseInt(page);
    if (page === null || isNaN(page)) page = 1;
  } catch (err) {
    page = 1;
  }
  if (page > 1) {
    page -= 1;
    window.location.href =
      window.location.origin +
      window.location.pathname +
      '?search=' +
      prompt +
      '&p=' +
      page.toString();
  }
}

function moveSearchPage(targetPage) {
  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const prompt = urlparams.get('search');

  window.location.href =
    window.location.origin +
    window.location.pathname +
    '?search=' +
    prompt +
    '&p=' +
    targetPage.toString();
}

function generateItemCard(item, type = 0, qty = 1) {
  const icard = document.createElement('div');
  icard.setAttribute(
    'class',
    'rounded overflow-hidden shadow-lg text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'
  );
  let cardContent = `
    <div class="px-6 py-4" onclick="goToItem([item-id-holder])">
      <div class="font-bold text-xl mb-2">[item-name-holder]</div>
      <p class="text-gray-700 text-base">
        [item-price-holder]
      </p>
      <p class="truncate text-gray-700 text-base">
        [item-description-holder]
      </p>
    </div>
  `;

  switch (type) {
    // home
    case 0:
      cardContent += `
      <div id="add-to-cart-div-[item-id-holder]" class="px-6 pt-4 pb-2 grid grid-cols-2 gap-4">
        <input type="number" id="item-qty-[item-id-holder]" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" value="[item-qty-holder]" required>
        <button onclick="addToCart(document.getElementById('item-qty-[item-id-holder]').value, [item-id-holder])" data-ratId="add[item-id-holder]" data-ratEvent="click" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Add to cart</button>
      </div>
      `;
      break;
    // cart
    case 1:
      cardContent += `
      <div class="px-6 pt-4 pb-2">
        <input type="number" id="item-qty-[item-id-holder]" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" value="[item-qty-holder]" onChange=updateCart([item-id-holder])>
      </div>
      `;
      break;
    // confirmation
    case 2:
      cardContent += `
      <div class="px-6 pt-4 pb-2">
        <input type="number" id="item-qty-[item-id-holder]" min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" value="[item-qty-holder]" readonly>
      </div>
      `;
      break;
  }

  cardContent = cardContent.replaceAll('[item-name-holder]', item.name);
  cardContent = cardContent.replaceAll('[item-price-holder]', item.price + '円');
  cardContent = cardContent.replaceAll('[item-description-holder]', item.description);
  cardContent = cardContent.replaceAll('[item-name-holder]', item.name);
  cardContent = cardContent.replaceAll('[item-id-holder]', item.id);
  cardContent = cardContent.replaceAll('[item-qty-holder]', qty.toString());

  icard.innerHTML = cardContent;
  return icard;
}

function getCategory() {
  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const prompt = urlparams.get('search');
  let page = urlparams.get('p');
  try {
    page = parseInt(page);
    if (page === null || isNaN(page)) page = 1;
  } catch (err) {
    page = 1;
  }

  const displayCount = 9;
  const BreakError = {};
  const results = items.filter((i) => i.categories.includes(prompt));
  const startInd = (page - 1) * displayCount;
  const endInd =
    startInd + displayCount <= results.length ? startInd + displayCount : results.length;

  createPgn(Math.ceil(results.length / displayCount), page);

  try {
    results.slice(startInd, endInd).forEach(function (item, index, arr) {
      const icard = generateItemCard(item);
      document.getElementById('item-display').appendChild(icard);
      bindButton(item.id);
    });
  } catch (err) {
    if (err !== BreakError) throw err;
  }

  displayCategories();
}

function displayRandomItems(count) {
  const shuffledItems = items.sort(() => 0.5 - Math.random());
  shuffledItems.slice(0, count).forEach(function (item, index, arr) {
    const icard = generateItemCard(item);
    document.getElementById('item-display').appendChild(icard);
    bindButton(item.id);
  });

  displayCategories();
}

function displayCategories() {
  let catList = [];
  items.forEach(function (item, index, arr) {
    catList = catList.concat(item.categories);
  });

  const uniqueCat = [...new Set(catList)].sort();
  uniqueCat.forEach(function (item, index, arr) {
    const listitem = document.createElement('li');
    const itemlink = document.createElement('a');
    itemlink.setAttribute('href', encodeURI('/category.html?search=' + item));
    itemlink.setAttribute(
      'class',
      'flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700'
    );
    const label = document.createElement('span');
    label.setAttribute('class', 'ml-3');
    label.innerHTML = item;
    itemlink.appendChild(label);
    listitem.appendChild(itemlink);
    document.getElementById('category-display').appendChild(listitem);
  });
}

function goToItem(id) {
  window.location.href = '/item.html?id=' + id;
}

function getBookmarkFromCookie() {
  const tmp = getCookie('_bmk');
  try {
    const bmkCk = JSON.parse(tmp);
    return bmkCk;
  } catch (e) {
    console.error(e);
    deleteCookie('_bmk');
    return [];
  }
}

function updateBookmarkButton(targetId) {
  const bmkCk = getBookmarkFromCookie();
  let val;
  let onclickfunc;
  if (bmkCk !== undefined && bmkCk.indexOf(targetId) !== -1) {
    val = 'Remove Bookmark';
    onclickfunc = 'removeBookmark(' + targetId.toString() + ')';
  } else {
    val = 'Add Bookmark';
    onclickfunc = 'addBookmark(' + targetId.toString() + ')';
  }
  const btns = document.querySelectorAll("[data-value='Bookmark']");
  btns.forEach((btn) => {
    btn.setAttribute('value', val);
    btn.setAttribute('onClick', onclickfunc);
  });
}

function getItemInfo() {
  initializeCarousel();
  // show the modal
  const modal = document.getElementById('defaultModal');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  // set modal close buttons
  const elements = document.querySelectorAll('[data-modal-hide]');
  elements.forEach((el) => {
    el.addEventListener('click', (e) => {
      const modal = document.getElementById('defaultModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    });
  });

  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const itemid = urlparams.get('id');

  const item = items.find(function (i, index) {
    if (i.id == itemid) return true;
  });

  const name = document.getElementById('item-name');
  const desc = document.getElementById('item-desc');
  const floatName = document.getElementById('float-name');
  const floatPrice = document.getElementById('float-price');
  name.innerHTML = item.name;
  desc.innerHTML = item.description;
  floatName.innerHTML = item.name;
  floatPrice.innerHTML = item.price.toString() + '円';
  updateBookmarkButton(item.id);

  const price = document.getElementById('item-price');
  price.innerHTML = item.price.toString() + '円';
}

function updateCart(id) {
  const currentCart = getCart();
  currentCart.forEach(function (item, index) {
    if (id == item.id) {
      item.qty = document.getElementById('item-qty-' + id).value;
    }
  });
  localStorage.setItem('cart', JSON.stringify(currentCart));
  const price = document.getElementById('total-price');
  price.innerHTML = 'Total: ' + calculateCartTotal().toString();
}

function addToCart(qty, id = null) {
  if (!isLoggedIn()) {
    window.location.href = '/login';
  } else if (qty > 0) {
    const query = window.location.search;
    const urlparams = new URLSearchParams(query);
    let itemid = urlparams.get('id');

    if (id != null) itemid = id;

    const currentCart = getCart();
    const exists = currentCart.find(function (i, index) {
      if (i.id == itemid) {
        i.qty = parseInt(i.qty) + parseInt(qty);
        return true;
      }
    });
    if (exists == undefined) {
      currentCart.push({
        id: itemid,
        qty: parseInt(qty)
      });
    }
    window.localStorage.setItem('cart', JSON.stringify(currentCart));
    window.alert('Added to cart!');
  }
}

function displayBookmarks() {
  if (!isLoggedIn()) window.location.href = '/login.html';
  const bmkListDisp = document.getElementById('bookmark-items');
  const bmks = getBookmarkFromCookie();
  if (!bmks) {
    return;
  }
  const itemsToDisplay = items.filter((item) => bmks.includes(item.id));

  itemsToDisplay.forEach((item) => {
    const tmp = createBookmarkListItem(item);
    bmkListDisp.appendChild(tmp);
  });
}

function addBookmark(itemid) {
  if (!isLoggedIn()) {
    window.location.href = '/login.html';
  } else {
    const bmkCk = getBookmarkFromCookie();
    if (!bmkCk.includes(itemid)) {
      bmkCk.push(itemid);
      setCookie('_bmk', JSON.stringify(bmkCk), 365);
      // add modal for confirmation
      window.alert('Bookmarked!');
      updateBookmarkButton(itemid);
    } else {
      window.alert('Already bookmarked.');
    }
  }
}

function removeBookmark(targetId) {
  let bmkCk = getBookmarkFromCookie();
  bmkCk = bmkCk.filter((val) => val != targetId);
  setCookie('_bmk', JSON.stringify(bmkCk), 365);
  updateBookmarkButton(targetId);
  window.alert('Bookmark removed!');
}

function clearBookmarks() {
  deleteCookie('_bmk');
}

function createBookmarkListItem(item) {
  const listItem = document.createElement('li');
  listItem.setAttribute('class', 'pb-1 pt-1');
  listItem.setAttribute('onclick', 'goToItem(' + item.id.toString() + ')');
  const listDiv = document.createElement('div');
  listDiv.setAttribute(
    'class',
    'flex items-center gap-4 space-x-4 rounded shadow-lg text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'
  );

  const imgDiv = document.createElement('div');
  imgDiv.setAttribute('class', 'flex-shrink-0');

  const img = document.createElement('img');
  img.setAttribute('class', 'w-8 h-8 rounded-full');
  img.setAttribute('src', '/assets/images/profile.png');
  img.setAttribute('alt', 'Neil image');

  const textDiv = document.createElement('div');
  textDiv.setAttribute('class', 'flex-1 min-w-0');

  const itemName = document.createElement('p');
  itemName.setAttribute('class', 'text-sm font-large pt-4 text-gray-900 truncate dark:text-white');
  const itemDesc = document.createElement('p');
  itemDesc.setAttribute('class', 'text-sm text-gray-500 pb-4 truncate dark:text-gray-400');

  const priceDiv = document.createElement('div');
  priceDiv.setAttribute(
    'class',
    'inline-flex items-center text-base font-semibold text-gray-900 dark:text-white'
  );

  imgDiv.appendChild(img);
  listDiv.appendChild(imgDiv);

  itemName.innerHTML = item.name;
  textDiv.appendChild(itemName);
  itemDesc.innerHTML = item.description;
  textDiv.appendChild(itemDesc);
  listDiv.appendChild(textDiv);

  priceDiv.innerHTML = item.price.toString() + '円';
  listDiv.appendChild(priceDiv);

  listItem.appendChild(listDiv);

  return listItem;
}

function confirmPurchase() {
  const query = window.location.search;
  const urlparams = new URLSearchParams(query);
  const prompt = urlparams.get('po');
  let paymentOption = '';
  switch (prompt) {
    case 'cc':
      paymentOption = 'Credit Card';
      break;
    case 'c':
      paymentOption = 'Cash';
      break;
    case 'cs':
      paymentOption = 'Convenience Store';
      break;
  }
  const paymentDisplay = document.getElementById('payment-option');
  if (paymentDisplay) {
    paymentDisplay.innerHTML = 'Payment Method: ' + paymentOption;
  }
  displayCart(false);
}

function clearCart() {
  if (window.localStorage.hasOwnProperty('cart')) {
    window.localStorage.removeItem('cart');
  }
  const list = document.getElementById('cart-items');
  list.innerHTML = '';
  const price = document.getElementById('total-price');
  price.innerHTML = '';
}

function goHome() {
  window.location.href = '/index';
}

function goToCart() {
  window.location.href = '/cart';
}

function goToConfirmPurchase() {
  if (isLoggedIn()) {
    const po = document.getElementsByName('payment-option');
    po.forEach((item, i) => {
      if (item.checked) {
        window.location.href = '/purchase_confirm.html?po=' + item.value;
      }
    });
  } else {
    window.location.href = '/login.html';
  }
}

function goToPaymentOptions() {
  if (localStorage.hasOwnProperty('cart')) window.location.href = '/payment_options.html';
}

function goToCompletePurchase() {
  if (isLoggedIn()) {
    window.location.href = '/purchase_complete';
  } else {
    window.location.href = '/login';
  }
}

function getCart() {
  if (window.localStorage.hasOwnProperty('cart'))
    return JSON.parse(window.localStorage.getItem('cart'));
  return [];
}

function calculateCartTotal() {
  const cart = getCart();
  return Math.round(
    (cart.reduce(function (acc, item) {
      const itemDetail = items.find(function (i, index) {
        if (item.id == i.id) return true;
      });
      if (!itemDetail) {
        return acc;
      }
      return acc + parseFloat(itemDetail.price) * item.qty;
    }, 0.0) *
      100) /
      100
  );
}

function displayCart(allowModify = false) {
  if (!isLoggedIn()) {
    window.location.href = '/login.html';
    return;
  }
  const cart = getCart();
  const list = document.getElementById('cart-items');

  const totalPrice = calculateCartTotal();

  cart.forEach(function (i, index) {
    const item = items.find(function (i2, index2) {
      if (i2.id == i.id) return true;
    });
    const icard = generateItemCard(item, allowModify ? 1 : 2, i.qty);
    list.appendChild(icard);
  });
  document.getElementById('total-price').innerHTML = 'Total: ' + totalPrice;
}

function moveCarousel(direction) {
  const carousel = document.getElementById('carousel');
  const activeItem = document.querySelector('[data-carousel-item="active"]');
  const activeIndex = Array.prototype.indexOf.call(carousel.children, activeItem);

  let targetIndex = (activeIndex + direction) % carousel.childElementCount;
  targetIndex = targetIndex >= 0 ? targetIndex : carousel.childElementCount + targetIndex;
  const targetItem = carousel.children[targetIndex];

  activeItem.setAttribute('class', 'hidden ' + activeItem.getAttribute('class'));
  activeItem.setAttribute('data-carousel-item', '');

  targetItem.setAttribute('class', targetItem.getAttribute('class').replace('hidden ', ''));
  targetItem.setAttribute('data-carousel-item', 'active');
}

function initializeCarousel() {
  const carousel = document.getElementById('carousel');
  const nextBtn = document.getElementById('carousel-next');
  const prevBtn = document.getElementById('carousel-prev');

  const itemClass = carousel.children[0].getAttribute('class');
  carousel.children[0].setAttribute('class', itemClass.replace('hidden ', ''));

  let carouselInterval = setInterval(() => {
    moveCarousel(1);
  }, 4000);

  nextBtn.addEventListener('click', () => {
    moveCarousel(1);
    clearInterval(carouselInterval);
    carouselInterval = setInterval(() => {
      moveCarousel(1);
    }, 4000);
  });

  prevBtn.addEventListener('click', () => {
    moveCarousel(-1);
    clearInterval(carouselInterval);
    carouselInterval = setInterval(() => {
      moveCarousel(1);
    }, 4000);
  });
}

function initializeIndex() {
  const cart = getCart();
  displayRandomItems(8);

  initializeCarousel();

  const logout = document.createElement('li');
  logout.setAttribute('id', 'logout-link');
  const logoutlink = document.createElement('a');
  logoutlink.setAttribute('href', '/logout.html');
  logoutlink.setAttribute(
    'class',
    'block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent'
  );
  logoutlink.innerHTML = 'Logout';
  logout.appendChild(logoutlink);

  const login = document.createElement('li');
  login.setAttribute('id', 'login-link');
  const loginlink = document.createElement('a');
  loginlink.setAttribute('href', '/login.html');
  loginlink.setAttribute(
    'class',
    'block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent'
  );
  loginlink.innerHTML = 'Login';
  login.appendChild(loginlink);

  const navbar = document.getElementById('navbar-options-container');

  // check if logged in
  if (isLoggedIn()) {
    const login = document.getElementById('login-link');
    if (login) login.parentNode.removeChild(login);
    navbar.appendChild(logout);
    document.getElementById('welcome-user').innerHTML = 'Welcome, ' + getCookie('_uu');
  } else {
    const logoutTmp = document.getElementById('logout-link');
    if (logoutTmp) logoutTmp.parentNode.removeChild(logoutTmp);
    navbar.appendChild(login);
    document.getElementById('welcome-user').innerHTML = '';
  }
}

/*
  add cookie
  name: <String> Cookie name
  value: <String> Cookie value
  duration: <Integer> Duration of cookie in days
*/
function setCookie(name, value, duration) {
  const date = new Date();
  date.setTime(date.getTime() + duration * 24 * 60 * 60 * 1000);
  document.cookie = name + '=' + value + '; expires=' + date.toUTCString() + ';path=/';
}

function deleteCookie(name) {
  document.cookie = name + '=; expires= Thu, 01 Jan 1969 00:00:00 UTC; path=/';
}

function getCookie(name) {
  const cookies = document.cookie.split('; ');
  for (let i = 0; i < cookies.length; i++) {
    const ck = cookies[i].split('=');
    if (ck[0] === name) return ck[1];
  }
  return null;
}

function isLoggedIn() {
  return getCookie('loggedin') !== null;
}

function login() {
  const uname = document.getElementById('uname').value;
  const pword = document.getElementById('pword').value;
  const loggedinUser = user.username == uname && user.password == pword;
  if (loggedinUser) {
    setCookie('loggedin', 'true', 365);
    // uname should be encrypted
    setCookie('_uu', uname, 365);
    if (
      document.referrer === '' ||
      document.referrer === window.location.href ||
      document.referrer.includes('logout.html')
    ) {
      window.location.href = window.location.origin;
    } else {
      window.location.href = document.referrer;
    }
  } else {
    document.getElementById('message').innerHTML = 'Failed to login';
    return;
  }
}

function logout() {
  deleteCookie('_uu');
  deleteCookie('loggedin');
  window.location.href = '/';
}
